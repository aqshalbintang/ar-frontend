<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Camera & View</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <style>
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
            pointer-events: none;
        }

        #backButton, #closeButton {
            position: absolute;
            top: 10px;
            background: rgb(255, 0, 0);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 3;
        }

        #backButton {
            left: 10px;
        }

        #closeButton {
            right: 10px;
            display: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="overlay"></div>

    <a-scene embedded arjs="debugUIEnabled: false" vr-mode-ui="enabled: false">
        <a-marker-camera preset="custom"></a-marker-camera>
        <a-entity id="arContent" position="0 1.2 -3"></a-entity>
        <a-light type="directional" intensity="0.8" position="1 1 1"></a-light>
    </a-scene>

    <button id="backButton">Kembali</button>
    <button id="closeButton">Tutup</button>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Silahkan registrasi atau login dahulu");
                window.location.href = "/";
                return;
            }

            try {
                const response = await fetch("http://localhost:8080/api/targets");
                const targets = await response.json();
                const scene = document.querySelector("a-scene");
                const arContent = document.getElementById("arContent");

                targets.forEach(target => {
                    if (target.patternFileUrl && target.objectUrl) {
                        const marker = document.createElement("a-marker");
                        marker.setAttribute("type", "pattern");
                        marker.setAttribute("url", target.patternFileUrl);

                        marker.addEventListener("markerFound", () => {
                            loadARContent(target.objectUrl, target.hasAudio);
                        });

                        scene.appendChild(marker);
                    }
                });

            } catch (error) {
                console.error("Gagal mengambil data marker:", error);
            }
        });

        let videoElement = null;

        function loadARContent(objectUrl, hasAudio) {
            const arContent = document.getElementById("arContent");
            const closeButton = document.getElementById("closeButton");
            const backButton = document.getElementById("backButton");
            const overlay = document.getElementById("overlay");
            
            arContent.innerHTML = "";
            closeButton.style.display = "block";
            backButton.style.display = "none";
            overlay.style.display = "block";
            
            const arType = objectUrl.split(".").pop().toLowerCase();

            if (["mp4", "webm", "ogg"].includes(arType)) {
                videoElement = document.createElement("video");
                videoElement.src = objectUrl;
                videoElement.loop = true;
                videoElement.crossOrigin = "anonymous";
                videoElement.setAttribute("playsinline", "true");
                
                if (hasAudio) {
                    videoElement.muted = false;
                    videoElement.controls = true;
                } else {
                    videoElement.muted = true;
                    videoElement.autoplay = true;
                }

                document.body.addEventListener("click", () => {
                    if (videoElement) {
                        videoElement.muted = false;
                        videoElement.play();
                    }
                });

                videoElement.onloadedmetadata = () => {
                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                    const video = document.createElement("a-video");
                    video.setAttribute("src", objectUrl);
                    video.setAttribute("width", "1.5");
                    video.setAttribute("height", (1.5 / aspectRatio).toFixed(2));
                    video.setAttribute("position", "0 0 -2");
                    video.setAttribute("look-at", "[camera]");
                    video.setAttribute("constraint", "keepInsideCameraView: true");
                    arContent.appendChild(video);
                };
            } else if (["jpg", "jpeg", "png", "gif"].includes(arType)) {
                const img = new Image();
                img.src = objectUrl;
                img.onload = () => {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const image = document.createElement("a-image");
                    image.setAttribute("src", objectUrl);
                    image.setAttribute("width", "1.5");
                    image.setAttribute("height", (1.5 / aspectRatio).toFixed(2));
                    image.setAttribute("position", "0 0 -2");
                    image.setAttribute("look-at", "[camera]");
                    image.setAttribute("constraint", "keepInsideCameraView: true");
                    arContent.appendChild(image);
                };
            }
        }

        document.getElementById("closeButton").addEventListener("click", () => {
            location.reload();
        });

        document.getElementById("backButton").addEventListener("click", () => {
            window.location.href = "/dashboard.html";
        });
    </script>
</body>

</html>
