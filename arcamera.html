<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Camera</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>    <style>
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
            pointer-events: none;
        }

        #backButton,
        #closeButton {
            position: absolute;
            top: 10px;
            background: rgb(255, 0, 0);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 3;
        }

        #backButton {
            left: 10px;
        }

        #closeButton {
            right: 10px;
            display: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="overlay"></div>

    <a-scene embedded arjs="debugUIEnabled: false" vr-mode-ui="enabled: false">
        <a-marker preset="custom">
        <a-entity id="arContent" position="0 0 -2">
        </a-marker>
        <a-entity camera></a-entity>
    <a-light type="directional" intensity="0.8" position="1 1 1"></a-light>
    </a-scene>

    <button id="backButton">
        <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAATxJREFUSEvt1cEqRUEcx/HvbycpRclzkGxESSnPwIoH4V14BukiUjY2VrK8Gx5ASlZ//vU/NXTde2aO43RzZ31mPvP/n5nfiI6GOnKZwH/W+fFqtZnNAYuSHkpblF2xmc0CN4Djq5KeSvAsONALYDmwE0m7rcJmNgNcA0sB3QMbkl5agwM999YGcgdslaK+xshWD0BvgW1JryWVVnOGwmY2DVwmlV4BO5LemqBDKw70DFgL5Bk4AOqifUn9nzY4sGIzmwJ6CVpS4JGkw/GAfZfR6tPPf7weu/ag2Afea5af3+pq4U4OV4J7cKR3uP3rNAT3ANlscpdHBsg3PI3MRulVG44D5y+TB0qV18eS9moeti+fZcEJ7s/iPLAiyYMle2TDgftbvCDpMVuMCUVwKZbOm8C/0cVaa/y/Vn8Alx5mH4moMicAAAAASUVORK5CYII=" />
    </button>
    <button id="closeButton">
        <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAAV1JREFUSEvtlb1KxEAUhb+jVnb2PoPgG4goirJoYSEKlrZa+EAWaiEiInY2omCjqK/iD/5gcc0Ns7DIbmY2CcYi04VM7nfPmTM3oqGlhri04D9zvrX6/1htZhPAGbAj6amoMzObB3aBVUnfRXsLz9jMRoBHYAp4BmYlPfQraGadbN8pMAZcSPLngSsaLjPbAvYhv/MvwJyku96KZrYcXHHoF9CRdFkJ7B//gr8F5Tm8D3RR0lUsLFHF3QJmtg4cBeU5HJgEjoO9H8BSCtRrJoODug3gMDTj8HHAc/AJLEi6jintvh8KHOCu/AAYDUVcqZ/7bSp0aMWNgc1sM6j1Hnqtfgc8VDepqpOtTgiXX6OkRCdb3ch1KjlAospTRuY9MA28AjOJI/Nc0kqlyRV+EidZmPayYj63B64wxbaBtUo/idSEltmXnOoyxStZXTew9Misq5HW6rqcjNZpzOofTLGEHzIu/6MAAAAASUVORK5CYII=" />
    </button>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Silahkan registrasi atau login dahulu");
                window.location.href = "/";
                return;
            }

            try {
                const response = await fetch("https://ar-backend-production.up.railway.app/api/targets");
                const targets = await response.json();
                const scene = document.querySelector("a-scene");
                const arContent = document.getElementById("arContent");

                targets.forEach(target => {
                    if (target.patternFileUrl && target.objectUrl) {
                        const marker = document.createElement("a-marker");
                        marker.setAttribute("type", "pattern");
                        marker.setAttribute("url", target.patternFileUrl);

                        marker.addEventListener("markerFound", () => {
                            loadARContent(target.objectUrl, target.hasAudio);
                        });

                        scene.appendChild(marker);
                    }
                });

            } catch (error) {
                console.error("Gagal mengambil data marker:", error);
            }
        });

        let videoElement = null;

        /* global AFRAME */
        AFRAME.registerComponent('play-on-click', {
            init: function () {
                this.onClick = this.onClick.bind(this);
            },
            play: function () {
                window.addEventListener('click', this.onClick);
            },
            pause: function () {
                window.removeEventListener('click', this.onClick);
            },
            onClick: function () {
                var videoEl = this.el.getAttribute('material').src;
                if (!videoEl) return;
                this.el.object3D.visible = true;
                videoEl.play().catch(err => console.warn("Autoplay gagal, user harus klik:", err));
            }
        });

        function loadARContent(objectUrl, hasAudio) {
            const arContent = document.getElementById("arContent");
            const closeButton = document.getElementById("closeButton");
            const backButton = document.getElementById("backButton");
            const overlay = document.getElementById("overlay");

            arContent.innerHTML = "";
            closeButton.style.display = "block";
            backButton.style.display = "none";
            overlay.style.display = "block";

            const arType = objectUrl.split(".").pop().toLowerCase();

            if (["mp4", "webm", "ogg"].includes(arType)) {
                const videoElement = document.createElement("video");
                videoElement.src = objectUrl;
                videoElement.loop = true;
                videoElement.crossOrigin = "anonymous";
                videoElement.playsInline = true;
                videoElement.autoplay = true;
                videoElement.muted = true; // Mulai dengan mute untuk bypass autoplay policy
                videoElement.style.display = "none"; // Sembunyikan elemen video asli

                // Tambahkan video ke DOM sebelum pemutaran
                arContent.appendChild(videoElement);

                videoElement.onloadeddata = () => {
                    videoElement.play().then(() => {
                        console.log("Video autoplay berhasil");

                        // Aktifkan audio setelah video mulai
                        if (hasAudio) {
                            setTimeout(() => {
                                videoElement.muted = false;
                                videoElement.volume = 1.0;
                            }, 500);
                        }
                    }).catch(e => {
                        console.warn("Autoplay gagal, meminta user action:", e);
                    });

                    // Tambahkan video ke AR
                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                    const video = document.createElement("a-video");
                    video.setAttribute("src", objectUrl);
                    video.setAttribute("width", "1.2");
                    video.setAttribute("height", (1.2 / aspectRatio).toFixed(2));
                    video.setAttribute("position", "0 0 -1");
                    video.setAttribute("look-at", "[camera]");
                    video.setAttribute("play-on-click", ""); // Tambahkan komponen play-on-click
                    arContent.appendChild(video);
                };

                // Trik tambahan: Sentuhan pertama memaksa video play
                function enableAutoplay() {
                    videoElement.play();
                    document.removeEventListener("click", enableAutoplay);
                    document.removeEventListener("touchstart", enableAutoplay);
                }

                document.addEventListener("click", enableAutoplay);
                document.addEventListener("touchstart", enableAutoplay);
            } else if (["jpg", "jpeg", "png", "gif"].includes(arType)) {
                const img = new Image();
                img.src = objectUrl;
                img.onload = () => {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const image = document.createElement("a-image");
                    image.setAttribute("src", objectUrl);
                    image.setAttribute("width", "1.2");
                    image.setAttribute("height", (1.2 / aspectRatio).toFixed(2));
                    image.setAttribute("position", "0 0 -1");
                    image.setAttribute("look-at", "[camera]");
                    arContent.appendChild(image);
                };
            }
        }
        document.getElementById("closeButton").addEventListener("click", () => {
            location.reload();
        });

        document.getElementById("backButton").addEventListener("click", () => {
            window.location.href = "/dashboard.html";
        });
    </script>
</body>

</html>