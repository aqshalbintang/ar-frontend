<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Camera & View</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <style>
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
            pointer-events: none;
        }

        #backButton, #closeButton {
            position: absolute;
            top: 10px;
            background: rgb(255, 0, 0);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 3;
        }

        #backButton {
            left: 10px;
        }

        #closeButton {
            right: 10px;
            display: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="overlay"></div>

    <a-scene embedded arjs="debugUIEnabled: false" vr-mode-ui="enabled: false">
        <a-marker-camera preset="custom"></a-marker-camera>
        <a-entity id="arContent" position="0 1.2 -3"></a-entity>
        <a-light type="directional" intensity="0.8" position="1 1 1"></a-light>
    </a-scene>

    <button id="backButton">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAATxJREFUSEvt1cEqRUEcx/HvbycpRclzkGxESSnPwIoH4V14BukiUjY2VrK8Gx5ASlZ//vU/NXTde2aO43RzZ31mPvP/n5nfiI6GOnKZwH/W+fFqtZnNAYuSHkpblF2xmc0CN4Djq5KeSvAsONALYDmwE0m7rcJmNgNcA0sB3QMbkl5agwM999YGcgdslaK+xshWD0BvgW1JryWVVnOGwmY2DVwmlV4BO5LemqBDKw70DFgL5Bk4AOqifUn9nzY4sGIzmwJ6CVpS4JGkw/GAfZfR6tPPf7weu/ag2Afea5af3+pq4U4OV4J7cKR3uP3rNAT3ANlscpdHBsg3PI3MRulVG44D5y+TB0qV18eS9moeti+fZcEJ7s/iPLAiyYMle2TDgftbvCDpMVuMCUVwKZbOm8C/0cVaa/y/Vn8Alx5mH4moMicAAAAASUVORK5CYII="/>
    </button>
    <button id="closeButton">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAAV1JREFUSEvtlb1KxEAUhb+jVnb2PoPgG4goirJoYSEKlrZa+EAWaiEiInY2omCjqK/iD/5gcc0Ns7DIbmY2CcYi04VM7nfPmTM3oqGlhri04D9zvrX6/1htZhPAGbAj6amoMzObB3aBVUnfRXsLz9jMRoBHYAp4BmYlPfQraGadbN8pMAZcSPLngSsaLjPbAvYhv/MvwJyku96KZrYcXHHoF9CRdFkJ7B//gr8F5Tm8D3RR0lUsLFHF3QJmtg4cBeU5HJgEjoO9H8BSCtRrJoODug3gMDTj8HHAc/AJLEi6jintvh8KHOCu/AAYDUVcqZ/7bSp0aMWNgc1sM6j1Hnqtfgc8VDepqpOtTgiXX6OkRCdb3ch1KjlAospTRuY9MA28AjOJI/Nc0kqlyRV+EidZmPayYj63B64wxbaBtUo/idSEltmXnOoyxStZXTew9Misq5HW6rqcjNZpzOofTLGEHzIu/6MAAAAASUVORK5CYII="/>
    </button>

    <script>
document.addEventListener("DOMContentLoaded", async function () {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Silahkan registrasi atau login dahulu");
        window.location.href = "/";
        return;
    }

    let arActive = false; // Variabel untuk mencegah deteksi ulang marker

    try {
        const response = await fetch("https://ar-backend-production.up.railway.app/api/targets");
        const targets = await response.json();
        const scene = document.querySelector("a-scene");
        const arContent = document.getElementById("arContent");

        targets.forEach(target => {
            if (target.patternFileUrl && target.objectUrl) {
                const marker = document.createElement("a-marker");
                marker.setAttribute("type", "pattern");
                marker.setAttribute("url", target.patternFileUrl);

                marker.addEventListener("markerFound", () => {
                    if (!arActive) {
                        arActive = true; // Blokir deteksi ulang marker
                        disableAllMarkers(scene);
                        loadARContent(target.objectUrl, target.hasAudio);
                    }
                });

                scene.appendChild(marker);
            }
        });

    } catch (error) {
        console.error("Gagal mengambil data marker:", error);
    }

    document.getElementById("closeButton").addEventListener("click", () => {
        location.reload();
    });

    document.getElementById("backButton").addEventListener("click", () => {
        window.location.href = "/dashboard.html";
    });

    function disableAllMarkers(scene) {
        const markers = scene.querySelectorAll("a-marker");
        markers.forEach(marker => marker.removeAttribute("detect-markers"));
    }
});


        let videoElement = null;

        function loadARContent(objectUrl, hasAudio) {
            const arContent = document.getElementById("arContent");
            const closeButton = document.getElementById("closeButton");
            const backButton = document.getElementById("backButton");
            const overlay = document.getElementById("overlay");
            
            arContent.innerHTML = "";
            closeButton.style.display = "block";
            backButton.style.display = "none";
            overlay.style.display = "block";
            
            const arType = objectUrl.split(".").pop().toLowerCase();

            if (["mp4", "webm", "ogg"].includes(arType)) {
                videoElement = document.createElement("video");
                videoElement.src = objectUrl;
                videoElement.loop = true;
                videoElement.crossOrigin = "anonymous";
                
                if (hasAudio) {
                    videoElement.muted = false;
                    videoElement.controls = true;
                } else {
                    videoElement.muted = true;
                    videoElement.autoplay = true;
                }

                videoElement.onloadedmetadata = () => {
                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                    const video = document.createElement("a-video");
                    video.setAttribute("src", objectUrl);
                    video.setAttribute("width", "1.5");
                    video.setAttribute("height", (1.5 / aspectRatio).toFixed(2));
                    video.setAttribute("position", "0 0 -3");
                    video.setAttribute("look-at", "[camera]");
                    arContent.appendChild(video);
                };
            } else if (["jpg", "jpeg", "png", "gif"].includes(arType)) {
                const img = new Image();
                img.src = objectUrl;
                img.onload = () => {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const image = document.createElement("a-image");
                    image.setAttribute("src", objectUrl);
                    image.setAttribute("width", "1.5");
                    image.setAttribute("height", (1.5 / aspectRatio).toFixed(2));
                    image.setAttribute("position", "0 0 -3");
                    image.setAttribute("look-at", "[camera]");
                    arContent.appendChild(image);
                };
            }
        }
    </script>
</body>

</html>
