<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR App</title>
    <link rel="stylesheet" href="styleCamera.css">
    <link rel="stylesheet" href="styleView.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">

    <!-- Halaman Camera -->
    <div id="cameraPage">
        <a-scene embedded arjs="debugUIEnabled: false" vr-mode-ui="enabled: false">
            <a-marker preset="custom"></a-marker>
        </a-scene>
        <a-entity camera></a-entity>

        <button id="backButton">
            <img
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAATJJREFUSEvtlrsyBUEURdfGNxHLRN4l8Czfo/yDR0KAwCMWCIRSJSOSyVGbrppRbeqOMbfbjOB2OFXnrN57zqNFT0c9cRmBO3O+tdW2t4BbSfcpt2wFtr0GHAKPwJSk52Hhvwbb3gD24asglySd/im4UHoAjAEGViUdDQsNcY2KbS8DxwX0HVhPhTaCC2hQNg68ASuSzlKUlrG1im3PAuEfltB5SZc5oLWKC+gJMAG8Ags5oQPBtueAAA1Kw9kBrjIovZP0MtBq2zPAeaE0A+tbimlJ1/8LHG5TKarwaRe4yCC/3uoyeS/FVYF3204RPEytbgdIBd7tyIzgYR12uyQi+CawFy2WxZS53bid4jaKHgJPn9NsspOHQKR8G7iR9JDS260Up4CqsSNwTjd/zNWb1R8xx3QfCUc1rgAAAABJRU5ErkJggg==" />
        </button>
    </div>

    <!-- Halaman View -->
    <div id="viewPage" style="display: none;">
        <div id="overlay"></div>
        <a-scene embedded arjs="debugUIEnabled: false" vr-mode-ui="enabled: false">
            <a-marker-camera preset="custom"></a-marker-camera>
            <a-entity id="arContent"></a-entity>
            <a-light type="directional" intensity="0.8" position="1 1 1"></a-light>
        </a-scene>
        <button id="closeButton">
            <img
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAAV1JREFUSEvtlb1KxEAUhb+jVnb2PoPgG4goirJoYSEKlrZa+EAWaiEiInY2omCjqK/iD/5gcc0Ns7DIbmY2CcYi04VM7nfPmTM3oqGlhri04D9zvrX6/1htZhPAGbAj6amoMzObB3aBVUnfRXsLz9jMRoBHYAp4BmYlPfQraGadbN8pMAZcSPLngSsaLjPbAvYhv/MvwJyku96KZrYcXHHoF9CRdFkJ7B//gr8F5Tm8D3RR0lUsLFHF3QJmtg4cBeU5HJgEjoO9H8BSCtRrJoODug3gMDTj8HHAc/AJLEi6jintvh8KHOCu/AAYDUVcqZ/7bSp0aMWNgc1sM6j1Hnqtfgc8VDepqpOtTgiXX6OkRCdb3ch1KjlAospTRuY9MA28AjOJI/Nc0kqlyRV+EidZmPayYj63B64wxbaBtUo/idSEltmXnOoyxStZXTew9Misq5HW6rqcjNZpzOofTLGEHzIu/6MAAAAASUVORK5CYII=" />
        </button>
    </div>

    <script>
const apiUrl = "https://ar-backend-production.up.railway.app";

document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Silahkan registrasi atau login dahulu");
        window.location.href = "/";
    }
    loadMarkers();
});

async function loadMarkers() {
    try {
        const response = await fetch(`${apiUrl}/api/targets`);
        const targets = await response.json();
        const scene = document.querySelector("#cameraPage a-scene");

        targets.forEach(target => {
            if (target.patternFileUrl && target.objectUrl) {
                const marker = document.createElement("a-marker");
                marker.setAttribute("type", "pattern");
                marker.setAttribute("url", target.patternFileUrl);
                marker.dataset.objectUrl = target.objectUrl;
                marker.dataset.arType = target.objectUrl.split(".").pop().toLowerCase();

                marker.addEventListener("markerFound", () => {
                    if (!localStorage.getItem("arScanned")) {
                        localStorage.setItem("arScanned", "true");
                        localStorage.setItem("arObjectUrl", marker.dataset.objectUrl);
                        localStorage.setItem("arType", marker.dataset.arType);

                        console.log("✅ Marker ditemukan:", marker.dataset.objectUrl);
                        showPage("viewPage");

                        // Tunggu scene siap, lalu muat AR
                        setTimeout(() => {
                            console.log("⏳ Loading AR Content...");
                            loadARContent();
                        }, 1000);
                    }
                });

                scene.appendChild(marker);
            }
        });

    } catch (error) {
        console.error("❌ Gagal mengambil data marker:", error);
    }
}

function loadARContent() {
    const arContent = document.getElementById("arContent");
    arContent.innerHTML = ""; // Bersihkan sebelumnya

    const objectUrl = localStorage.getItem("arObjectUrl");
    const arType = localStorage.getItem("arType");

    console.log("📌 Data yang di-load:", { objectUrl, arType });

    if (!objectUrl || !arType) {
        console.error("❌ Data AR tidak ditemukan!");
        return;
    }

    let object;
    if (["mp4", "webm", "ogg"].includes(arType)) {
        object = document.createElement("a-video");
        object.setAttribute("src", objectUrl);
        object.setAttribute("width", "1");
        object.setAttribute("height", "0.56");
        object.setAttribute("position", "0 1.2 -3");
        object.setAttribute("autoplay", "true");
        object.setAttribute("loop", "true");
        console.log("🎥 Video AR ditambahkan.");
    } else if (["jpg", "jpeg", "png", "gif"].includes(arType)) {
        object = document.createElement("a-image");
        object.setAttribute("src", objectUrl);
        object.setAttribute("width", "1");
        object.setAttribute("height", "0.56");
        object.setAttribute("position", "0 1.2 -3");
        console.log("🖼️ Gambar AR ditambahkan.");
    } else {
        console.error("❌ Format tidak dikenali:", arType);
        return;
    }

    // Pastikan objek ditampilkan di scene yang benar
    const scene = document.querySelector("#viewPage a-scene");
    if (scene) {
        console.log("✅ Scene ditemukan, menambahkan objek...");
        scene.appendChild(object);
    } else {
        console.error("❌ Scene tidak ditemukan di viewPage!");
    }
}

function showPage(pageId) {
    document.getElementById("cameraPage").style.display = pageId === "cameraPage" ? "block" : "none";
    document.getElementById("viewPage").style.display = pageId === "viewPage" ? "block" : "none";

    if (pageId === "cameraPage") {
        localStorage.removeItem("arScanned"); // Reset scan jika kembali ke kamera
    }
}

document.getElementById("backButton").addEventListener("click", () => {
    window.location.href = "/dashboard.html";
});

document.getElementById("closeButton").addEventListener("click", () => {
    showPage("cameraPage");
});
    </script>

</body>

</html>